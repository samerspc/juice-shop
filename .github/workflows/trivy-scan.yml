name: Trivy Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (optional)
        run: |
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        continue-on-error: true

      - name: Generate SBOM
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'cyclonedx'
          output: 'sbom.json'
        continue-on-error: true

      - name: Scan SBOM for vulnerabilities
        uses: aquasecurity/trivy-action@master
        if: hashFiles('sbom.json') != ''
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom.json'
          format: 'table'
          output: 'vulnerabilities.txt'
        continue-on-error: true

      - name: Generate JSON report
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        continue-on-error: true

      - name: Generate HTML report
        if: hashFiles('trivy-results.json') != ''
        run: |
          # Create simple HTML report from JSON
          python3 << 'EOF'
          import json
          import html
          
          try:
              with open('trivy-results.json', 'r') as f:
                  data = json.load(f)
              
              html_content = """<!DOCTYPE html>
          <html>
          <head>
              <title>Trivy Security Report</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                  .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  h1 { color: #333; }
                  .summary { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0; }
                  table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                  th, td { padding: 12px; text-align: left; border: 1px solid #ddd; }
                  th { background: #1976d2; color: white; }
                  .critical { background: #ffebee; }
                  .high { background: #fff3e0; }
                  .medium { background: #fffde7; }
                  .low { background: #e8f5e9; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Trivy Security Scan Report</h1>
                  <div class="summary">
                      <h2>Summary</h2>
                      <p><strong>Scan Date:</strong> """ + data.get('CreatedAt', 'N/A') + """</p>
          """
              
              total_vulns = 0
              if 'Results' in data:
                  for result in data['Results']:
                      if 'Vulnerabilities' in result:
                          total_vulns += len(result['Vulnerabilities'])
              
              html_content += f"<p><strong>Total Vulnerabilities:</strong> {total_vulns}</p></div>"
              
              if 'Results' in data and data['Results']:
                  html_content += "<h2>Vulnerabilities</h2><table><tr><th>ID</th><th>Severity</th><th>Package</th><th>Title</th></tr>"
                  for result in data['Results']:
                      if 'Vulnerabilities' in result:
                          for vuln in result['Vulnerabilities']:
                              severity = vuln.get('Severity', 'UNKNOWN').lower()
                              html_content += f"<tr class='{severity}'><td>{html.escape(str(vuln.get('VulnerabilityID', 'N/A')))}</td>"
                              html_content += f"<td>{html.escape(str(vuln.get('Severity', 'N/A')))}</td>"
                              html_content += f"<td>{html.escape(str(vuln.get('PkgName', 'N/A')))}</td>"
                              html_content += f"<td>{html.escape(str(vuln.get('Title', 'N/A')))}</td></tr>"
                  html_content += "</table>"
              else:
                  html_content += "<p>No vulnerabilities found.</p>"
              
              html_content += "</div></body></html>"
              
              with open('trivy-report.html', 'w') as f:
                  f.write(html_content)
              print("HTML report generated successfully")
          except Exception as e:
              print(f"Error generating HTML report: {e}")
              # Create minimal HTML report
              with open('trivy-report.html', 'w') as f:
                  f.write("""<!DOCTYPE html><html><head><title>Trivy Report</title></head><body><h1>Trivy Security Report</h1><p>Report generation in progress or no vulnerabilities found.</p></body></html>""")
          EOF
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report
          path: |
            trivy-report.html
            sbom.json
            vulnerabilities.txt
          retention-days: 7

