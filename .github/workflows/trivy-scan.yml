name: Trivy Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y
          trivy --version

      - name: Install root dependencies
        run: |
          echo "Installing root dependencies..."
          npm install --ignore-scripts 2>&1 || true
          echo "Root packages installed"
        continue-on-error: true

      - name: Install frontend dependencies
        run: |
          if [ -f frontend/package.json ]; then
            echo "Installing frontend dependencies..."
            cd frontend
            npm install --ignore-scripts 2>&1 || true
            echo "Frontend packages installed"
          fi
        continue-on-error: true

      - name: Verify installation
        run: |
          echo "=== Checking package.json files ==="
          find . -name "package.json" -not -path "*/node_modules/*" | head -10
          echo ""
          echo "=== Checking node_modules ==="
          ls -la node_modules 2>/dev/null | head -5 || echo "No root node_modules"
          ls -la frontend/node_modules 2>/dev/null | head -5 || echo "No frontend node_modules"

      - name: Run Trivy filesystem scan
        run: |
          echo "=== Running Trivy fs scan ==="
          trivy fs . --scanners vuln --format json --output trivy-results.json --severity CRITICAL,HIGH,MEDIUM,LOW 2>&1 | tail -20 || true
          echo "Trivy scan completed"
        continue-on-error: true

      - name: Run npm audit
        run: |
          echo "=== NPM Audit Results ==="
          npm audit --json > npm-audit.json 2>/dev/null || true
          npm audit 2>/dev/null | head -50 || echo "npm audit completed"
        continue-on-error: true

      - name: Generate SBOM with Trivy
        run: |
          echo "=== Generating SBOM ==="
          trivy fs . --format cyclonedx --output sbom.json --scanners vuln 2>&1 | tail -10 || true
          echo "SBOM generation completed"
        continue-on-error: true

      - name: Generate SARIF report
        run: |
          trivy fs . --format sarif --output trivy-results.sarif --scanners vuln --severity CRITICAL,HIGH,MEDIUM,LOW 2>&1 | tail -10 || true
        continue-on-error: true

      - name: Generate package-lock and scan
        run: |
          echo "=== Scanning package-lock.json ==="
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only 2>/dev/null || true
          fi
          if [ -f package-lock.json ]; then
            trivy fs package-lock.json --scanners vuln --format table 2>&1 | head -100 || true
          fi
        continue-on-error: true

      - name: Generate HTML report
        shell: python3 {0}
        run: |
          import json
          import html
          import subprocess
          import os
          
          vulns = []
          source = "Unknown"
          
          # Try npm audit first (more reliable for npm projects)
          try:
              if os.path.exists('npm-audit.json'):
                  with open('npm-audit.json') as f:
                      npm_data = json.load(f)
                  if 'vulnerabilities' in npm_data:
                      source = "npm audit"
                      for pkg, info in npm_data['vulnerabilities'].items():
                          via = info.get('via', [])
                          title = 'N/A'
                          vuln_id = 'N/A'
                          if isinstance(via, list) and via:
                              if isinstance(via[0], dict):
                                  title = via[0].get('title', 'N/A')
                                  vuln_id = via[0].get('url', 'N/A')
                          vulns.append({
                              'package': pkg,
                              'severity': info.get('severity', 'unknown').upper(),
                              'title': title,
                              'id': vuln_id
                          })
          except Exception as e:
              print(f"npm audit parse error: {e}")
          
          # Try trivy results
          if not vulns:
              try:
                  if os.path.exists('trivy-results.json'):
                      with open('trivy-results.json') as f:
                          data = json.load(f)
                      if 'Results' in data:
                          source = "Trivy"
                          for result in data['Results']:
                              if 'Vulnerabilities' in result:
                                  for v in result['Vulnerabilities']:
                                      vulns.append({
                                          'id': v.get('VulnerabilityID', 'N/A'),
                                          'severity': v.get('Severity', 'UNKNOWN'),
                                          'package': v.get('PkgName', 'N/A'),
                                          'title': v.get('Title', 'N/A')
                                      })
              except Exception as e:
                  print(f"trivy parse error: {e}")
          
          # Count by severity
          severity_counts = {}
          for v in vulns:
              sev = v.get('severity', 'UNKNOWN').upper()
              severity_counts[sev] = severity_counts.get(sev, 0) + 1
          
          html_content = f"""<!DOCTYPE html>
          <html>
          <head>
              <title>Security Scan Report</title>
              <style>
                  body {{ font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
                  .container {{ background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }}
                  h1 {{ color: #333; }}
                  .summary {{ background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0; }}
                  .warning {{ background: #fff3e0; padding: 15px; border-radius: 5px; margin: 20px 0; }}
                  table {{ width: 100%; border-collapse: collapse; margin: 20px 0; }}
                  th, td {{ padding: 12px; text-align: left; border: 1px solid #ddd; }}
                  th {{ background: #1976d2; color: white; }}
                  .critical {{ background: #ffebee; }}
                  .high {{ background: #fff3e0; }}
                  .medium, .moderate {{ background: #fffde7; }}
                  .low {{ background: #e8f5e9; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Security Scan Report</h1>
                  <div class="summary">
                      <h2>Summary</h2>
                      <p><strong>Total Vulnerabilities:</strong> {len(vulns)}</p>
                      <p><strong>By Severity:</strong> {', '.join([f'{k}: {v}' for k, v in sorted(severity_counts.items())])}</p>
                      <p><strong>Source:</strong> {source}</p>
                  </div>
          """
          
          if vulns:
              html_content += "<h2>Vulnerabilities</h2><table><tr><th>ID</th><th>Severity</th><th>Package</th><th>Title</th></tr>"
              for v in vulns:
                  sev_class = v.get('severity', 'unknown').lower()
                  html_content += f"<tr class='{sev_class}'>"
                  html_content += f"<td>{html.escape(str(v.get('id', 'N/A')))}</td>"
                  html_content += f"<td>{html.escape(str(v.get('severity', 'N/A')))}</td>"
                  html_content += f"<td>{html.escape(str(v.get('package', 'N/A')))}</td>"
                  html_content += f"<td>{html.escape(str(v.get('title', 'N/A')))}</td>"
                  html_content += "</tr>"
              html_content += "</table>"
          else:
              html_content += "<div class='warning'><p>No vulnerabilities detected.</p></div>"
          
          html_content += "</div></body></html>"
          
          with open('trivy-report.html', 'w') as f:
              f.write(html_content)
          print(f"HTML report generated with {len(vulns)} vulnerabilities from {source}")
        continue-on-error: true

      - name: Generate vulnerabilities.txt
        run: |
          echo "=== Vulnerability Summary ===" > vulnerabilities.txt
          npm audit 2>/dev/null >> vulnerabilities.txt || echo "See HTML report" >> vulnerabilities.txt
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report
          path: |
            trivy-report.html
            trivy-results.json
            sbom.json
            vulnerabilities.txt
            npm-audit.json
          retention-days: 7
          if-no-files-found: ignore
