name: Trivy Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y
          trivy --version

      - name: Install root dependencies
        run: |
          echo "Installing root dependencies..."
          npm install --ignore-scripts 2>&1 || true
          echo "Root packages installed: $(ls node_modules 2>/dev/null | wc -l)"
        continue-on-error: true

      - name: Install frontend dependencies
        run: |
          if [ -f frontend/package.json ]; then
            echo "Installing frontend dependencies..."
            cd frontend
            npm install --ignore-scripts 2>&1 || true
            echo "Frontend packages installed: $(ls node_modules 2>/dev/null | wc -l)"
          fi
        continue-on-error: true

      - name: Verify installation
        run: |
          echo "=== Checking package.json files ==="
          find . -name "package.json" -not -path "*/node_modules/*" | head -10
          echo ""
          echo "=== Checking node_modules ==="
          if [ -d "node_modules" ]; then
            echo "Root node_modules: $(ls node_modules | wc -l) packages"
          fi
          if [ -d "frontend/node_modules" ]; then
            echo "Frontend node_modules: $(ls frontend/node_modules | wc -l) packages"
          fi

      - name: Run Trivy filesystem scan (with verbose)
        run: |
          echo "=== Running Trivy fs scan ==="
          trivy fs . --scanners vuln --format json --output trivy-results.json --severity CRITICAL,HIGH,MEDIUM,LOW --debug 2>&1 | head -100 || true
          
          echo ""
          echo "=== JSON Results Summary ==="
          if [ -f trivy-results.json ]; then
            python3 -c "
import json
try:
    with open('trivy-results.json') as f:
        d = json.load(f)
    results = d.get('Results', [])
    print(f'Found {len(results)} result groups')
    total = 0
    for r in results:
        vulns = r.get('Vulnerabilities', [])
        if vulns:
            print(f'  - {r.get(\"Target\", \"unknown\")}: {len(vulns)} vulnerabilities')
            total += len(vulns)
    print(f'Total vulnerabilities: {total}')
except Exception as e:
    print(f'Error: {e}')
"
          fi
        continue-on-error: true

      - name: Run npm audit for comparison
        run: |
          echo "=== NPM Audit Results ==="
          npm audit --json 2>/dev/null | python3 -c "
import json, sys
try:
    d = json.load(sys.stdin)
    v = d.get('metadata', {}).get('vulnerabilities', {})
    print(f'NPM Audit found: Critical={v.get(\"critical\",0)}, High={v.get(\"high\",0)}, Moderate={v.get(\"moderate\",0)}, Low={v.get(\"low\",0)}')
except: pass
" || true
        continue-on-error: true

      - name: Generate SBOM with Trivy
        run: |
          echo "=== Generating SBOM ==="
          trivy fs . --format cyclonedx --output sbom.json --scanners vuln 2>&1 | tail -20 || true
          if [ -f sbom.json ]; then
            echo "SBOM size: $(wc -c < sbom.json) bytes"
            python3 -c "
import json
try:
    with open('sbom.json') as f:
        d = json.load(f)
    components = d.get('components', [])
    print(f'SBOM contains {len(components)} components')
except Exception as e:
    print(f'Error: {e}')
"
          fi
        continue-on-error: true

      - name: Generate SARIF report
        run: |
          trivy fs . --format sarif --output trivy-results.sarif --scanners vuln --severity CRITICAL,HIGH,MEDIUM,LOW 2>&1 | tail -10 || true
        continue-on-error: true

      - name: Scan using package-lock.json directly
        run: |
          echo "=== Scanning package-lock.json ==="
          if [ -f package-lock.json ]; then
            trivy fs package-lock.json --scanners vuln --format table 2>&1 | head -50 || true
          else
            echo "No package-lock.json found, generating one..."
            npm install --package-lock-only 2>/dev/null || true
            if [ -f package-lock.json ]; then
              trivy fs package-lock.json --scanners vuln --format table 2>&1 | head -50 || true
            fi
          fi
        continue-on-error: true

      - name: Generate HTML report
        run: |
          python3 << 'EOF'
          import json
          import html
          import subprocess
          
          # Try to get npm audit data as fallback
          npm_vulns = []
          try:
              result = subprocess.run(['npm', 'audit', '--json'], capture_output=True, text=True, timeout=60)
              npm_data = json.loads(result.stdout)
              if 'vulnerabilities' in npm_data:
                  for pkg, info in npm_data['vulnerabilities'].items():
                      npm_vulns.append({
                          'package': pkg,
                          'severity': info.get('severity', 'unknown').upper(),
                          'title': info.get('via', [{}])[0].get('title', 'N/A') if isinstance(info.get('via', []), list) and info.get('via') else 'N/A',
                          'id': info.get('via', [{}])[0].get('url', 'N/A') if isinstance(info.get('via', []), list) and info.get('via') else 'N/A'
                      })
          except:
              pass
          
          # Try trivy results
          trivy_vulns = []
          try:
              with open('trivy-results.json', 'r') as f:
                  data = json.load(f)
              if 'Results' in data:
                  for result in data['Results']:
                      if 'Vulnerabilities' in result:
                          for v in result['Vulnerabilities']:
                              trivy_vulns.append({
                                  'id': v.get('VulnerabilityID', 'N/A'),
                                  'severity': v.get('Severity', 'UNKNOWN'),
                                  'package': v.get('PkgName', 'N/A'),
                                  'title': v.get('Title', 'N/A')
                              })
          except:
              pass
          
          # Use npm audit if trivy found nothing
          vulns = trivy_vulns if trivy_vulns else npm_vulns
          
          html_content = """<!DOCTYPE html>
          <html>
          <head>
              <title>Security Scan Report</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                  .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }
                  h1 { color: #333; }
                  .summary { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0; }
                  .warning { background: #fff3e0; padding: 15px; border-radius: 5px; margin: 20px 0; }
                  table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                  th, td { padding: 12px; text-align: left; border: 1px solid #ddd; }
                  th { background: #1976d2; color: white; }
                  .critical { background: #ffebee; }
                  .high { background: #fff3e0; }
                  .medium, .moderate { background: #fffde7; }
                  .low { background: #e8f5e9; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üîí Security Scan Report</h1>
                  <div class="summary">
                      <h2>Summary</h2>
          """
          
          html_content += f"<p><strong>Total Vulnerabilities:</strong> {len(vulns)}</p>"
          
          # Count by severity
          severity_counts = {}
          for v in vulns:
              sev = v.get('severity', 'UNKNOWN').upper()
              severity_counts[sev] = severity_counts.get(sev, 0) + 1
          
          if severity_counts:
              html_content += "<p><strong>By Severity:</strong> "
              html_content += ", ".join([f"{k}: {v}" for k, v in sorted(severity_counts.items())])
              html_content += "</p>"
          
          html_content += f"<p><strong>Source:</strong> {'Trivy' if trivy_vulns else 'npm audit'}</p>"
          html_content += "</div>"
          
          if vulns:
              html_content += "<h2>Vulnerabilities</h2><table><tr><th>ID</th><th>Severity</th><th>Package</th><th>Title</th></tr>"
              for v in vulns:
                  sev_class = v.get('severity', 'unknown').lower()
                  html_content += f"<tr class='{sev_class}'>"
                  html_content += f"<td>{html.escape(str(v.get('id', 'N/A')))}</td>"
                  html_content += f"<td>{html.escape(str(v.get('severity', 'N/A')))}</td>"
                  html_content += f"<td>{html.escape(str(v.get('package', 'N/A')))}</td>"
                  html_content += f"<td>{html.escape(str(v.get('title', 'N/A')))}</td>"
                  html_content += "</tr>"
              html_content += "</table>"
          else:
              html_content += "<div class='warning'><p>‚ö†Ô∏è No vulnerabilities were detected by the scanner.</p></div>"
          
          html_content += "</div></body></html>"
          
          with open('trivy-report.html', 'w') as f:
              f.write(html_content)
          print(f"HTML report generated with {len(vulns)} vulnerabilities")
          EOF
        continue-on-error: true

      - name: Generate vulnerabilities.txt
        run: |
          echo "=== Vulnerability Summary ===" > vulnerabilities.txt
          echo "" >> vulnerabilities.txt
          npm audit 2>/dev/null >> vulnerabilities.txt || echo "npm audit not available" >> vulnerabilities.txt
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report
          path: |
            trivy-report.html
            trivy-results.json
            sbom.json
            vulnerabilities.txt
          retention-days: 7
          if-no-files-found: ignore
